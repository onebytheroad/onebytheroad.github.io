<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode }}" dir="{{ default `ltr` .Language.LanguageDirection }}">
    <head>
        {{- partial "head/head.html" . -}}
        {{- block "head" . -}}{{ end }}
        {{ $styles := resources.Get "css/custom.css" | minify }}
        <link rel="stylesheet" href="{{ $styles.Permalink }}">
        <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸŒ¸</text></svg>">
    </head>
    <body class="{{ block `body-class` . }}{{ end }}">
        {{- partial "head/colorScheme" . -}}

        {{- $hasWidget := false -}}
        {{- range .Site.Params.widgets -}}
            {{- if gt (len .) 0 -}}
                {{- $hasWidget = true -}}
            {{- end -}}
        {{- end -}}
        
        <div class="container main-container flex on-phone--column {{ if $hasWidget }}extended{{ else }}compact{{ end }}">
            {{- block "left-sidebar" . -}}
                {{ partial "sidebar/left.html" . }}
            {{- end -}}
            {{- block "right-sidebar" . -}}{{ end }}
            <main class="main full-width">
                {{- block "main" . }}{{- end }}
            </main>
        </div>
        
        {{ partial "footer/include.html" . }}

        {{/* åŠ¨æ€æ’å…¥éŸ³ä¹æ’­æ”¾å™¨å’Œæ¨±èŠ±ç‰¹æ•ˆ */}}
        <script>
        // åŠ¨æ€æ’å…¥éŸ³ä¹æ’­æ”¾å™¨
        function initGlobalMusicPlayer() {
            if (!document.getElementById('global-music-player')) {
                const playerHTML = `
                    <div id="global-music-player" style="position: fixed; bottom: 20px; right: 20px; z-index: 99999; background: red; border: 3px solid blue; padding: 15px;">
                        <audio id="bgMusic" loop>
                            <source src="/music/background.mp3" type="audio/mpeg">
                        </audio>
                        <button id="musicToggle" style="background: green; color: white; border: none; padding: 15px 20px; border-radius: 50%; cursor: pointer; font-size: 20px;">
                            ğŸµ æ’­æ”¾
                        </button>
                        <div id="musicStatus" style="margin-top: 10px; font-size: 14px; color: black; font-weight: bold;">
                            ç‚¹å‡»æ’­æ”¾
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', playerHTML);
                
                // åˆå§‹åŒ–æ’­æ”¾å™¨é€»è¾‘
                const audio = document.getElementById('bgMusic');
                const toggleBtn = document.getElementById('musicToggle');
                const status = document.getElementById('musicStatus');
                
                // æ¢å¤æ’­æ”¾çŠ¶æ€å’Œè¿›åº¦
                const savedState = localStorage.getItem('globalMusicState');
                const savedTime = localStorage.getItem('globalMusicTime');
                
                // æ¢å¤æ’­æ”¾è¿›åº¦
                if (savedTime) {
                    audio.currentTime = parseFloat(savedTime);
                }
                
                function updateButtonState(isPlaying) {
                    if (isPlaying) {
                        status.textContent = 'ğŸ¶ æ’­æ”¾ä¸­...';
                        toggleBtn.innerHTML = 'â¸ æš‚åœ';
                        toggleBtn.style.background = 'orange';
                    } else {
                        status.textContent = 'â¹ å·²æš‚åœ';
                        toggleBtn.innerHTML = 'ğŸµ æ’­æ”¾';
                        toggleBtn.style.background = 'green';
                    }
                }
                
                // å°è¯•è‡ªåŠ¨æ¢å¤æ’­æ”¾ï¼ˆæœ‰ç”¨æˆ·äº¤äº’çš„æƒ…å†µä¸‹ï¼‰
                function tryAutoResume() {
                    const savedState = localStorage.getItem('globalMusicState');
                    if (savedState === 'playing') {
                        // å…ˆé™éŸ³æ’­æ”¾ï¼Œç„¶åå–æ¶ˆé™éŸ³ï¼ˆç»•è¿‡è‡ªåŠ¨æ’­æ”¾é™åˆ¶ï¼‰
                        audio.muted = true;
                        audio.play().then(() => {
                            audio.muted = false;
                            updateButtonState(true);
                        }).catch(error => {
                            // å¦‚æœè‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œæ˜¾ç¤ºç‚¹å‡»æç¤º
                            status.textContent = 'ç‚¹å‡»æ¢å¤æ’­æ”¾';
                            updateButtonState(false);
                        });
                    }
                }
                
                // é¡µé¢åŠ è½½åå°è¯•è‡ªåŠ¨æ¢å¤ï¼ˆå¦‚æœæœ‰ç”¨æˆ·äº¤äº’å†å²ï¼‰
                setTimeout(tryAutoResume, 1000);
                
                // ç›‘å¬ç”¨æˆ·äº¤äº’ï¼Œè§¦å‘è‡ªåŠ¨æ’­æ”¾
                let userInteracted = false;
                const interactionEvents = ['click', 'touchstart', 'keydown', 'scroll'];
                
                interactionEvents.forEach(eventType => {
                    document.addEventListener(eventType, function() {
                        if (!userInteracted) {
                            userInteracted = true;
                            const savedState = localStorage.getItem('globalMusicState');
                            if (savedState === 'playing' && audio.paused) {
                                audio.play().then(() => {
                                    updateButtonState(true);
                                });
                            }
                        }
                    }, { once: true, passive: true });
                });
                
                toggleBtn.addEventListener('click', function() {
                    userInteracted = true; // æ ‡è®°ç”¨æˆ·å·²äº¤äº’
                    if (audio.paused) {
                        audio.play().then(() => {
                            updateButtonState(true);
                            localStorage.setItem('globalMusicState', 'playing');
                        }).catch(error => {
                            status.textContent = 'âŒ æ’­æ”¾å¤±è´¥';
                        });
                    } else {
                        audio.pause();
                        updateButtonState(false);
                        localStorage.setItem('globalMusicState', 'paused');
                    }
                });
                
                // å®šæœŸä¿å­˜æ’­æ”¾è¿›åº¦
                audio.addEventListener('timeupdate', function() {
                    localStorage.setItem('globalMusicTime', audio.currentTime);
                });
                
                // é¡µé¢å¸è½½å‰ä¿å­˜çŠ¶æ€
                window.addEventListener('beforeunload', function() {
                    localStorage.setItem('globalMusicTime', audio.currentTime);
                    localStorage.setItem('globalMusicState', audio.paused ? 'paused' : 'playing');
                });

                // ç›‘å¬éŸ³é¢‘åŠ è½½å®Œæˆ
                audio.addEventListener('loadeddata', function() {
                    console.log('éŸ³é¢‘åŠ è½½å®Œæˆï¼Œå°è¯•æ¢å¤æ’­æ”¾çŠ¶æ€');
                });
            }
        }

        // åŠ¨æ€æ’å…¥æ¨±èŠ±ç‰¹æ•ˆ
        function initSakuraEffect() {
            if (!document.getElementById('sakura-container')) {
                const sakuraHTML = `
                    <div id="sakura-container" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9998; overflow: hidden;"></div>
                `;
                document.body.insertAdjacentHTML('beforeend', sakuraHTML);
                
                // æ¨±èŠ±ç‰¹æ•ˆé€»è¾‘
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes sakuraFall {
                        0% { transform: translateY(-100px) rotate(0deg); opacity: 0.8; }
                        100% { transform: translateY(100vh) rotate(180deg); opacity: 0; }
                    }
                    .sakura { position: absolute; top: -50px; font-size: 18px; animation: sakuraFall linear forwards; user-select: none; pointer-events: none; }
                `;
                document.head.appendChild(style);
                
                let sakuraCount = 0;
                const maxSakuras = 10;
                
                function createSakura() {
                    if (sakuraCount >= maxSakuras) return;
                    
                    const sakura = document.createElement('div');
                    sakura.className = 'sakura';
                    sakura.innerHTML = 'ğŸŒ¸';
                    sakura.style.left = Math.random() * 100 + 'vw';
                    sakura.style.fontSize = (16 + Math.random() * 16) + 'px';
                    sakura.style.animationDuration = (10 + Math.random() * 10) + 's';
                    sakura.style.animationDelay = (Math.random() * 3) + 's';
                    
                    document.getElementById('sakura-container').appendChild(sakura);
                    sakuraCount++;
                    
                    setTimeout(() => {
                        if (sakura.parentNode) {
                            sakura.remove();
                            sakuraCount--;
                        }
                    }, 20000);
                }
                
                setTimeout(() => {
                    setInterval(createSakura, 1200);
                    for (let i = 0; i < 5; i++) {
                        setTimeout(createSakura, i * 800);
                    }
                }, 2000);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initGlobalMusicPlayer();
            initSakuraEffect();
        });

        // èƒŒæ™¯åŠ¨ç”»
        setTimeout(function() {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/gh/hustcc/canvas-nest.js@1.0.1/dist/canvas-nest.min.js';
            script.async = true;
            document.body.appendChild(script);
        }, 1500);
        </script>
    </body>
</html>